<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgroLinguo - Learn Farming</title>
    <!-- PWA Support -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#22c55e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="AgroLinguo">
    <link rel="apple-touch-icon" href="icon-192.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <!-- Neural Learning Engine (100% offline) -->
    <script src="neural_engine.js"></script>
    <!-- Question modules - loaded dynamically based on language -->
    <script>
        // Get language preference (default: en)
        const LANG = localStorage.getItem('agrolinguo_lang') || 'en';
        const LANG_PATH = 'questions/' + LANG + '/';

        // Dynamically load question modules
        for (let i = 1; i <= 10; i++) {
            const script = document.createElement('script');
            script.src = LANG_PATH + 'questions_module' + i + '.js';
            script.async = false;
            document.head.appendChild(script);
        }

        // Language info
        window.CURRENT_LANG = LANG;
        window.AVAILABLE_LANGS = {
            'en': { name: 'English', flag: 'üá¨üáß' },
            'sw': { name: 'Kiswahili', flag: 'üá∞üá™' }
        };
    </script>
    <!-- Course configuration -->
    <script src="course_config.js"></script>
    <!-- Main loader -->
    <script src="questions.js"></script>
    <style>
        * { font-family: 'Nunito', sans-serif; }
        .progress-ring { transform: rotate(-90deg); }
        /* ALL ANIMATIONS DISABLED - static UI only */
        .bounce-in { }
        .shake { }
        .pulse { }
        /* Stable feedback panel - uses transform instead of animation */
        .feedback-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            min-height: 180px;
            transition: transform 0.3s ease-out;
            will-change: transform;
            z-index: 50;
        }
        .feedback-panel.hidden {
            transform: translateY(100%);
            pointer-events: none;
        }
        .feedback-panel.visible {
            transform: translateY(0);
            pointer-events: auto;
        }
        .glow { box-shadow: 0 0 20px rgba(34, 197, 94, 0.5); }

        /* Duolingo-style tlaƒç√≠tka */
        .btn-answer {
            transform: translateY(0);
            box-shadow: 0 4px 0 #d1d5db;
            transition: all 0.1s ease;
        }
        .btn-answer:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 #d1d5db;
        }
        .btn-answer.selected {
            box-shadow: 0 4px 0 #22c55e;
            border-color: #22c55e;
            background: #dcfce7;
        }
        .btn-answer.selected:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 #22c55e;
        }
        .btn-answer.correct {
            box-shadow: 0 4px 0 #16a34a;
            animation: correctPop 0.4s ease;
        }
        .btn-answer.wrong {
            box-shadow: 0 4px 0 #dc2626;
            animation: wrongShake 0.4s ease;
        }
        @keyframes correctPop {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        @keyframes wrongShake {
            0%, 100% { transform: translateX(0); }
            20% { transform: translateX(-8px); }
            40% { transform: translateX(8px); }
            60% { transform: translateX(-8px); }
            80% { transform: translateX(8px); }
        }

        /* Efekt √∫spƒõchu */
        .success-burst {
            position: relative;
        }
        .success-burst::after {
            content: '‚ú®';
            position: absolute;
            font-size: 24px;
            animation: burstOut 0.6s ease-out forwards;
            pointer-events: none;
        }
        @keyframes burstOut {
            0% { opacity: 1; transform: scale(0.5) translateY(0); }
            100% { opacity: 0; transform: scale(1.5) translateY(-30px); }
        }

        /* ========================================
           MOBILN√ç OPTIMALIZACE (360-420px Android)
           Pro low-literacy users - vƒõt≈°√≠ prvky
           ======================================== */
        @media (max-width: 600px) {
            /* Hlavn√≠ kontejner */
            .mobile-container {
                padding: 12px 16px;
            }

            /* Karta ot√°zky - vƒõt≈°√≠ padding a zaoblen√≠ */
            .question-card {
                padding: 18px 20px !important;
                border-radius: 18px !important;
                margin-bottom: 16px !important;
            }

            /* Text ot√°zky - vƒõt≈°√≠ pro ƒçitelnost */
            .question-text {
                font-size: 20px !important;
                line-height: 1.4 !important;
                font-weight: 700 !important;
            }

            /* Ikona ot√°zky */
            .question-icon {
                font-size: 36px !important;
                min-width: 44px !important;
            }

            /* Tlaƒç√≠tka odpovƒõd√≠ - velk√° klikac√≠ plocha */
            .btn-answer {
                min-height: 68px !important;
                padding: 18px 20px !important;
                border-radius: 16px !important;
                margin-bottom: 12px !important;
                box-shadow: 0 5px 0 #d1d5db !important;
            }

            /* Text odpovƒõdi */
            .answer-text {
                font-size: 18px !important;
                font-weight: 600 !important;
            }

            /* Ikona odpovƒõdi */
            .answer-icon {
                font-size: 28px !important;
                min-width: 40px !important;
            }

            /* Mezery mezi odpovƒõƒèmi */
            .answers-container {
                gap: 14px !important;
            }

            /* Progress bar */
            .progress-bar {
                height: 10px !important;
                border-radius: 5px !important;
            }

            /* Header - srd√≠ƒçka */
            .hearts-display {
                font-size: 22px !important;
            }

            /* Spodn√≠ feedback panel */
            .feedback-panel {
                padding: 20px !important;
                border-radius: 24px 24px 0 0 !important;
            }

            .feedback-text {
                font-size: 18px !important;
            }

            .feedback-title {
                font-size: 22px !important;
            }

            .feedback-emoji {
                font-size: 48px !important;
            }

            /* Tlaƒç√≠tko pokraƒçovat */
            .continue-btn {
                min-height: 60px !important;
                font-size: 20px !important;
                border-radius: 16px !important;
                padding: 16px 24px !important;
            }

            /* Vƒõt≈°√≠ dotykov√° oblast pro X tlaƒç√≠tko */
            .close-btn {
                min-width: 48px !important;
                min-height: 48px !important;
                font-size: 24px !important;
            }
        }

        /* Extra mal√© telefony (< 360px) */
        @media (max-width: 360px) {
            .question-text {
                font-size: 18px !important;
            }
            .btn-answer {
                min-height: 60px !important;
                padding: 14px 16px !important;
            }
            .answer-text {
                font-size: 16px !important;
            }
        }

        /* ALL ANIMATIONS DISABLED */
        .confetti { display: none; }
        .star-burst { }
        .float-up { }
    </style>
</head>
<body class="bg-gradient-to-b from-green-50 to-green-100 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        // Hlavn√≠ komponenta aplikace
        function App() {
            const [screen, setScreen] = useState('home');
            const [selectedModule, setSelectedModule] = useState(null);
            const [selectedLevel, setSelectedLevel] = useState(null);
            const [currentQuestion, setCurrentQuestion] = useState(0);
            const [score, setScore] = useState(0);
            const [hearts, setHearts] = useState(5);
            const [xp, setXp] = useState(0);
            const [totalXp, setTotalXp] = useState(0);
            const [streak, setStreak] = useState(0);
            const [showAnswer, setShowAnswer] = useState(false);
            const [selectedAnswer, setSelectedAnswer] = useState(null);
            const [levelProgress, setLevelProgress] = useState({});
            const [dailyGoal, setDailyGoal] = useState(50);
            const [dailyXp, setDailyXp] = useState(0);

            // === LANGUAGE STATE ===
            const [currentLang, setCurrentLang] = useState(() => window.CURRENT_LANG || 'en');
            const [showLangSelect, setShowLangSelect] = useState(() => !localStorage.getItem('agrolinguo_lang_selected'));
            const [isChangingLang, setIsChangingLang] = useState(false);

            // === TRANSLATIONS ===
            const translations = {
                en: {
                    courses: 'Courses',
                    dailyGoal: 'Daily Goal',
                    level: 'Level',
                    levels: 'levels',
                    farmer: 'Farmer',
                    home: 'Home',
                    learn: 'Learn',
                    skills: 'Skills',
                    profile: 'Profile',
                    correct: 'Correct',
                    excellent: 'Excellent!',
                    goodJob: 'Good job!',
                    tryAgain: 'Try again!',
                    notQuite: 'Not quite',
                    continue: 'Continue',
                    finish: 'Finish',
                    nextLevel: 'Next Level',
                    playAgain: 'Play Again',
                    backToOverview: 'Back to Overview',
                    backHome: 'Back Home',
                    outOfHearts: 'Out of hearts!',
                    dontGiveUp: "Don't give up, try again!",
                    xpToNextLevel: 'XP to next level',
                    levelProgress: 'Level Progress',
                    totalXp: 'Total XP',
                    streak: 'Streak',
                    completed: 'Completed',
                    neuralEngine: 'Neural Engine',
                    knowledge: 'Knowledge',
                    momentum: 'Momentum',
                    strong: 'Strong',
                    practice: 'Practice',
                    interactions: 'interactions',
                    offlineAi: 'Offline AI',
                    exploring: 'Exploring',
                    accelerating: 'Accelerating!',
                    consolidating: 'Consolidating',
                    mastering: 'Mastering!',
                    keepGoing: 'Keep Going!',
                    chooseLanguage: 'Choose Language',
                    backToHome: 'Back to Home',
                    selectLevel: 'Select Level',
                    question: 'Question',
                    downloadApp: 'Download App',
                    installApp: 'Install to Phone',
                    downloadDesc: 'Save for offline use',
                    installDesc: 'Add to home screen'
                },
                sw: {
                    courses: 'Kozi',
                    dailyGoal: 'Lengo la Leo',
                    level: 'Kiwango',
                    levels: 'viwango',
                    farmer: 'Mkulima',
                    home: 'Nyumbani',
                    learn: 'Jifunze',
                    skills: 'Ujuzi',
                    profile: 'Wasifu',
                    correct: 'Sahihi',
                    excellent: 'Vizuri sana!',
                    goodJob: 'Umefanya vizuri!',
                    tryAgain: 'Jaribu tena!',
                    notQuite: 'Si sawa kabisa',
                    continue: 'Endelea',
                    finish: 'Maliza',
                    nextLevel: 'Kiwango Kifuatacho',
                    playAgain: 'Cheza Tena',
                    backToOverview: 'Rudi Nyuma',
                    backHome: 'Rudi Nyumbani',
                    outOfHearts: 'Mioyo imeisha!',
                    dontGiveUp: 'Usikate tamaa, jaribu tena!',
                    xpToNextLevel: 'XP hadi kiwango kifuatacho',
                    levelProgress: 'Maendeleo ya Kiwango',
                    totalXp: 'Jumla XP',
                    streak: 'Mfululizo',
                    completed: 'Imekamilika',
                    neuralEngine: 'Injini ya Akili',
                    knowledge: 'Ujuzi',
                    momentum: 'Kasi',
                    strong: 'Imara',
                    practice: 'Fanya Mazoezi',
                    interactions: 'maingiliano',
                    offlineAi: 'AI Offline',
                    exploring: 'Kuchunguza',
                    accelerating: 'Kuongeza kasi!',
                    consolidating: 'Kuimarisha',
                    mastering: 'Kutawala!',
                    keepGoing: 'Endelea!',
                    chooseLanguage: 'Chagua Lugha',
                    backToHome: 'Rudi Nyumbani',
                    selectLevel: 'Chagua Kiwango',
                    question: 'Swali',
                    downloadApp: 'Pakua Programu',
                    installApp: 'Weka kwenye Simu',
                    downloadDesc: 'Hifadhi kwa matumizi bila mtandao',
                    installDesc: 'Ongeza kwenye skrini ya nyumbani',
                    statistics: 'Takwimu',
                    exportData: 'Hamisha Data',
                    exportJson: 'Hamisha JSON',
                    exportCsv: 'Hamisha CSV',
                    totalQuestions: 'Maswali Yote',
                    correctAnswers: 'Majibu Sahihi',
                    incorrectAnswers: 'Majibu Yasiyo Sahihi',
                    accuracy: 'Usahihi',
                    avgResponseTime: 'Muda wa Wastani',
                    totalTime: 'Muda Jumla',
                    sessions: 'Vipindi',
                    moduleStats: 'Takwimu za Moduli',
                    learningCurve: 'Grafu ya Kujifunza',
                    researchExport: 'Hamisha kwa Utafiti',
                    resetStats: 'Futa Takwimu',
                    confirmReset: 'Una uhakika unataka kufuta takwimu zote?',
                    noData: 'Hakuna data bado. Anza kujifunza!',
                    seconds: 'sekunde',
                    minutes: 'dakika',
                    hours: 'masaa',
                    questionsAnswered: 'Maswali Yaliyojibiwa',
                    performanceOverTime: 'Utendaji kwa Wakati',
                    last7Days: 'Siku 7 Zilizopita',
                    allTime: 'Wakati Wote'
                }
            };

            // Extended translations for English
            translations.en = {
                ...translations.en,
                statistics: 'Statistics',
                exportData: 'Export Data',
                exportJson: 'Export JSON',
                exportCsv: 'Export CSV',
                totalQuestions: 'Total Questions',
                correctAnswers: 'Correct Answers',
                incorrectAnswers: 'Incorrect Answers',
                accuracy: 'Accuracy',
                avgResponseTime: 'Avg Response Time',
                totalTime: 'Total Time',
                sessions: 'Sessions',
                moduleStats: 'Module Statistics',
                learningCurve: 'Learning Curve',
                researchExport: 'Research Export',
                resetStats: 'Reset Statistics',
                confirmReset: 'Are you sure you want to reset all statistics?',
                noData: 'No data yet. Start learning!',
                seconds: 'seconds',
                minutes: 'minutes',
                hours: 'hours',
                questionsAnswered: 'Questions Answered',
                performanceOverTime: 'Performance Over Time',
                last7Days: 'Last 7 Days',
                allTime: 'All Time'
            };

            // Translation function
            const t = (key) => translations[currentLang]?.[key] || translations.en[key] || key;

            // Localized module text helper
            const lt = (obj) => {
                if (typeof obj === 'string') return obj;
                return obj?.[currentLang] || obj?.['en'] || obj || '';
            };

            // === NEURAL ENGINE STATE ===
            const [neuralState, setNeuralState] = useState(() => window.NeuralEngine?.getState() || {});
            const [questionStartTime, setQuestionStartTime] = useState(Date.now());
            const [showNeuralPanel, setShowNeuralPanel] = useState(false);

            // === TAB NAVIGATION STATE ===
            const [activeTab, setActiveTab] = useState('home');

            // === RESEARCH STATISTICS STATE ===
            const [researchStats, setResearchStats] = useState(() => {
                const saved = localStorage.getItem('agrolinguo_research_stats');
                if (saved) {
                    try {
                        return JSON.parse(saved);
                    } catch (e) {
                        console.error('Failed to parse research stats:', e);
                    }
                }
                return {
                    startDate: Date.now(),
                    totalQuestions: 0,
                    correctAnswers: 0,
                    incorrectAnswers: 0,
                    totalResponseTimeMs: 0,
                    totalSessionTimeMs: 0,
                    sessions: [],
                    answerHistory: [], // detailed log of all answers
                    moduleStats: {}, // per-module statistics
                    dailyStats: {}, // per-day statistics
                    currentSessionStart: Date.now()
                };
            });

            // === 30 MINUTE SESSION TIMER (isolated component) ===
            const SESSION_DURATION = 30 * 60;
            const sessionStartTimeRef = React.useRef(Date.now());

            const formatTimer = (seconds) => {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            };

            // Self-contained Timer component - doesn't cause parent re-renders
            const SessionTimer = React.memo(() => {
                const [elapsed, setElapsed] = useState(0);

                useEffect(() => {
                    const timer = setInterval(() => {
                        setElapsed(Math.floor((Date.now() - sessionStartTimeRef.current) / 1000));
                    }, 1000);
                    return () => clearInterval(timer);
                }, []);

                const remaining = Math.max(0, SESSION_DURATION - elapsed);
                const timeUp = remaining === 0;

                return (
                    <div className={`rounded-2xl p-3 shadow-lg mb-3 text-white ${timeUp ? 'bg-gradient-to-r from-red-500 to-red-600' : 'bg-gradient-to-r from-orange-500 to-red-500'}`}>
                        <div className="flex items-center justify-between">
                            <div className="flex items-center gap-2">
                                <span className="text-2xl">‚è±Ô∏è</span>
                                <div>
                                    <div className="font-bold text-sm">{timeUp ? '‚è∞ TIME UP!' : 'Session Time'}</div>
                                    <div className="text-[10px] opacity-80">30 min research</div>
                                </div>
                            </div>
                            <div className="text-right">
                                <div className="text-3xl font-bold font-mono">{formatTimer(elapsed)}</div>
                                <div className="text-[10px] opacity-80">{timeUp ? 'completed' : `${formatTimer(remaining)} left`}</div>
                            </div>
                        </div>
                        <div className="mt-2 bg-white/20 rounded-full h-2 overflow-hidden">
                            <div
                                className="bg-white h-full transition-all duration-1000"
                                style={{width: `${Math.min((elapsed / SESSION_DURATION) * 100, 100)}%`}}
                            />
                        </div>
                    </div>
                );
            });

            // Mini timer for quiz header - isolated component
            const MiniTimer = React.memo(() => {
                const [elapsed, setElapsed] = useState(0);
                useEffect(() => {
                    const timer = setInterval(() => {
                        setElapsed(Math.floor((Date.now() - sessionStartTimeRef.current) / 1000));
                    }, 1000);
                    return () => clearInterval(timer);
                }, []);
                const timeUp = elapsed >= SESSION_DURATION;
                return (
                    <div className={`flex items-center justify-center gap-2 mb-2 py-1 px-3 rounded-full text-sm font-bold ${timeUp ? 'bg-red-100 text-red-600' : 'bg-orange-100 text-orange-600'}`}>
                        <span>‚è±Ô∏è</span>
                        <span className="font-mono">{formatTimer(elapsed)}</span>
                        <span className="text-xs opacity-70">/ 30:00</span>
                    </div>
                );
            });

            const isTimeUp = false; // Checked only in timer components

            // Save research stats when they change
            useEffect(() => {
                localStorage.setItem('agrolinguo_research_stats', JSON.stringify(researchStats));
            }, [researchStats]);

            // Track session time - only on unmount, NO interval
            useEffect(() => {
                const sessionStart = Date.now();
                return () => {
                    const sessionEnd = Date.now();
                    const duration = sessionEnd - sessionStart;
                    setResearchStats(prev => ({
                        ...prev,
                        totalSessionTimeMs: prev.totalSessionTimeMs + duration,
                        sessions: [...prev.sessions, {
                            start: sessionStart,
                            end: sessionEnd,
                            duration: duration
                        }]
                    }));
                };
            }, []);

            // Function to record answer for research
            const recordAnswerForResearch = (moduleId, levelNum, questionIndex, isCorrect, responseTimeMs, questionText) => {
                const now = Date.now();
                const today = new Date().toISOString().split('T')[0];

                setResearchStats(prev => {
                    const moduleKey = `module_${moduleId}`;
                    const moduleStats = prev.moduleStats[moduleKey] || {
                        total: 0, correct: 0, incorrect: 0, totalTimeMs: 0, levels: {}
                    };

                    const levelKey = `level_${levelNum}`;
                    const levelStats = moduleStats.levels[levelKey] || {
                        total: 0, correct: 0, incorrect: 0, totalTimeMs: 0
                    };

                    const dailyStats = prev.dailyStats[today] || {
                        total: 0, correct: 0, incorrect: 0, totalTimeMs: 0
                    };

                    return {
                        ...prev,
                        totalQuestions: prev.totalQuestions + 1,
                        correctAnswers: prev.correctAnswers + (isCorrect ? 1 : 0),
                        incorrectAnswers: prev.incorrectAnswers + (isCorrect ? 0 : 1),
                        totalResponseTimeMs: prev.totalResponseTimeMs + responseTimeMs,
                        answerHistory: [...prev.answerHistory, {
                            timestamp: now,
                            moduleId,
                            levelNum,
                            questionIndex,
                            isCorrect,
                            responseTimeMs,
                            questionText: questionText?.substring(0, 100) // truncate for storage
                        }].slice(-1000), // Keep last 1000 answers
                        moduleStats: {
                            ...prev.moduleStats,
                            [moduleKey]: {
                                ...moduleStats,
                                total: moduleStats.total + 1,
                                correct: moduleStats.correct + (isCorrect ? 1 : 0),
                                incorrect: moduleStats.incorrect + (isCorrect ? 0 : 1),
                                totalTimeMs: moduleStats.totalTimeMs + responseTimeMs,
                                levels: {
                                    ...moduleStats.levels,
                                    [levelKey]: {
                                        ...levelStats,
                                        total: levelStats.total + 1,
                                        correct: levelStats.correct + (isCorrect ? 1 : 0),
                                        incorrect: levelStats.incorrect + (isCorrect ? 0 : 1),
                                        totalTimeMs: levelStats.totalTimeMs + responseTimeMs
                                    }
                                }
                            }
                        },
                        dailyStats: {
                            ...prev.dailyStats,
                            [today]: {
                                ...dailyStats,
                                total: dailyStats.total + 1,
                                correct: dailyStats.correct + (isCorrect ? 1 : 0),
                                incorrect: dailyStats.incorrect + (isCorrect ? 0 : 1),
                                totalTimeMs: dailyStats.totalTimeMs + responseTimeMs
                            }
                        }
                    };
                });
            };

            // Export functions for research
            const exportStatsAsJSON = () => {
                const exportData = {
                    ...researchStats,
                    exportDate: new Date().toISOString(),
                    language: currentLang,
                    playerLevel,
                    totalXp,
                    streak,
                    levelProgress,
                    neuralState: window.NeuralEngine?.getState()
                };

                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `agrolinguo_research_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            };

            const exportStatsAsCSV = () => {
                // Create CSV header
                let csv = 'timestamp,date,time,moduleId,levelNum,questionIndex,isCorrect,responseTimeMs,questionText\n';

                // Add each answer as a row
                researchStats.answerHistory.forEach(answer => {
                    const date = new Date(answer.timestamp);
                    csv += `${answer.timestamp},${date.toISOString().split('T')[0]},${date.toTimeString().split(' ')[0]},`;
                    csv += `${answer.moduleId},${answer.levelNum},${answer.questionIndex},`;
                    csv += `${answer.isCorrect ? 1 : 0},${answer.responseTimeMs},"${(answer.questionText || '').replace(/"/g, '""')}"\n`;
                });

                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `agrolinguo_answers_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                URL.revokeObjectURL(url);
            };

            const resetResearchStats = () => {
                if (window.confirm(t('confirmReset'))) {
                    const newStats = {
                        startDate: Date.now(),
                        totalQuestions: 0,
                        correctAnswers: 0,
                        incorrectAnswers: 0,
                        totalResponseTimeMs: 0,
                        totalSessionTimeMs: 0,
                        sessions: [],
                        answerHistory: [],
                        moduleStats: {},
                        dailyStats: {},
                        currentSessionStart: Date.now()
                    };
                    setResearchStats(newStats);
                    localStorage.setItem('agrolinguo_research_stats', JSON.stringify(newStats));
                }
            };

            // Naƒç√≠st ulo≈æen√° data
            useEffect(() => {
                const saved = localStorage.getItem('agrolinguo_save');
                if (saved) {
                    const data = JSON.parse(saved);
                    setTotalXp(data.totalXp || 0);
                    setStreak(data.streak || 0);
                    setLevelProgress(data.levelProgress || {});
                    setDailyXp(data.dailyXp || 0);
                    setHearts(data.hearts || 5);
                }
            }, []);

            // Ulo≈æit data
            useEffect(() => {
                localStorage.setItem('agrolinguo_save', JSON.stringify({
                    totalXp, streak, levelProgress, dailyXp, hearts
                }));
            }, [totalXp, streak, levelProgress, dailyXp, hearts]);

            // Vypoƒç√≠tat level hr√°ƒçe
            const playerLevel = Math.floor(totalXp / 100) + 1;
            const xpToNextLevel = 100 - (totalXp % 100);

            // Course modules - loaded dynamically from course_config.js + questions.js
            const modules = getModules();

            // Z√≠skat ot√°zky pro level
            const getQuestionsForLevel = (moduleId, levelNum) => {
                const key = `module${moduleId}_level${levelNum}`;
                if (window.ALL_QUESTIONS && window.ALL_QUESTIONS[moduleId] && window.ALL_QUESTIONS[moduleId][key]) {
                    return window.ALL_QUESTIONS[moduleId][key];
                }
                return [];
            };

            // Spustit level
            const startLevel = (moduleId, levelNum) => {
                setSelectedModule(moduleId);
                setSelectedLevel(levelNum);
                setCurrentQuestion(0);
                setScore(0);
                setXp(0);
                setShowAnswer(false);
                setSelectedAnswer(null);
                setQuestionStartTime(Date.now()); // Track response time
                setScreen('quiz');
            };

            // Zpracovat odpovƒõƒè
            const handleAnswer = (answerIndex) => {
                if (showAnswer) return;

                const questions = getQuestionsForLevel(selectedModule, selectedLevel);
                const question = questions[currentQuestion];
                const isCorrect = question.options[answerIndex].isCorrect;

                setSelectedAnswer(answerIndex);
                setShowAnswer(true);

                // === NEURAL ENGINE UPDATE ===
                const responseTime = Date.now() - questionStartTime;
                const neuralState = window.NeuralEngine.processAnswer(
                    selectedModule,
                    currentQuestion,
                    isCorrect,
                    responseTime
                );
                setNeuralState(neuralState);
                console.log('[Neural] State:', neuralState.phase, 'Momentum:', neuralState.momentum.toFixed(2));

                // === RESEARCH STATISTICS UPDATE ===
                recordAnswerForResearch(
                    selectedModule,
                    selectedLevel,
                    currentQuestion,
                    isCorrect,
                    responseTime,
                    question.question
                );

                if (isCorrect) {
                    setScore(s => s + 1);
                    // Adaptive XP based on prediction
                    const prediction = window.NeuralEngine.predictSuccess(selectedModule, currentQuestion);
                    const bonusXp = prediction < 0.5 ? 15 : 10; // More XP for harder questions
                    setXp(x => x + bonusXp);
                } else {
                    setHearts(h => Math.max(0, h - 1));
                }
            };

            // Dal≈°√≠ ot√°zka
            const nextQuestion = () => {
                const questions = getQuestionsForLevel(selectedModule, selectedLevel);

                if (hearts <= 0) {
                    setScreen('gameover');
                    return;
                }

                if (currentQuestion + 1 >= questions.length) {
                    finishLevel();
                } else {
                    setCurrentQuestion(c => c + 1);
                    setShowAnswer(false);
                    setSelectedAnswer(null);
                    setQuestionStartTime(Date.now()); // Reset timer for next question
                }
            };

            // Dokonƒçit level
            const finishLevel = () => {
                const questions = getQuestionsForLevel(selectedModule, selectedLevel);
                const percentage = (score / questions.length) * 100;
                const stars = percentage >= 90 ? 3 : percentage >= 70 ? 2 : percentage >= 50 ? 1 : 0;

                const levelKey = `${selectedModule}-${selectedLevel}`;
                const prevStars = levelProgress[levelKey] || 0;

                if (stars > prevStars) {
                    setLevelProgress(prev => ({...prev, [levelKey]: stars}));
                }

                const earnedXp = xp + (stars * 5);
                setTotalXp(t => t + earnedXp);
                setDailyXp(d => d + earnedXp);

                if (stars >= 2) {
                    setStreak(s => s + 1);
                    if (streak > 0 && streak % 5 === 4) {
                        setGems(g => g + 10);
                    }
                }

                setScreen('results');
            };

            // Resetovat srd√≠ƒçka
            const refillHearts = () => {
                setHearts(5);
            };

            // === LANGUAGE SELECTION ===
            const selectLanguage = (lang) => {
                setIsChangingLang(true);
                localStorage.setItem('agrolinguo_lang', lang);
                localStorage.setItem('agrolinguo_lang_selected', 'true');
                // Small delay to show loading state before reload
                setTimeout(() => {
                    window.location.reload();
                }, 100);
            };

            const changeLanguage = () => {
                setShowLangSelect(true);
            };

            // === LANGUAGE SELECT SCREEN ===
            const LanguageSelectScreen = () => {
                const langs = window.AVAILABLE_LANGS || {
                    'en': { name: 'English', flag: 'üá¨üáß' },
                    'sw': { name: 'Kiswahili', flag: 'üá∞üá™' }
                };

                // Show loading screen when changing language
                if (isChangingLang) {
                    return (
                        <div className="h-screen bg-gradient-to-b from-green-50 to-green-100 flex flex-col items-center justify-center p-4">
                            <div className="text-center">
                                <div className="text-8xl mb-4">üå±</div>
                                <h1 className="text-2xl font-bold text-green-700">Loading...</h1>
                            </div>
                        </div>
                    );
                }

                return (
                    <div className="h-screen bg-gradient-to-b from-green-50 to-green-100 flex flex-col items-center justify-center p-4">
                        <div className="text-center">
                            <div className="text-8xl mb-4">üå±</div>
                            <h1 className="text-4xl font-bold text-green-700 mb-2">AgroLinguo</h1>
                            <p className="text-gray-600 mb-8">Learn farming, grow knowledge</p>

                            <h2 className="text-xl font-bold text-gray-700 mb-4">
                                {t('chooseLanguage')}
                            </h2>

                            <div className="space-y-3 max-w-xs mx-auto">
                                {Object.entries(langs).map(([code, lang]) => (
                                    <button
                                        key={code}
                                        onClick={() => selectLanguage(code)}
                                        disabled={isChangingLang}
                                        className={`w-full py-4 px-6 rounded-2xl font-bold text-lg flex items-center justify-center gap-3 transition transform hover:scale-[1.02] active:scale-[0.98] ${
                                            currentLang === code
                                                ? 'bg-gradient-to-r from-green-500 to-green-600 text-white shadow-lg'
                                                : 'bg-white border-2 border-gray-200 text-gray-700 hover:border-green-400'
                                        }`}
                                    >
                                        <span className="text-3xl">{lang.flag}</span>
                                        <span>{lang.name}</span>
                                        {currentLang === code && <span className="ml-auto">‚úì</span>}
                                    </button>
                                ))}
                            </div>

                            {localStorage.getItem('agrolinguo_lang_selected') && (
                                <button
                                    onClick={() => setShowLangSelect(false)}
                                    className="mt-6 text-gray-500 underline"
                                >
                                    {t('backToHome')}
                                </button>
                            )}
                        </div>
                    </div>
                );
            };

            // Header komponenta
            const [showHeaderMenu, setShowHeaderMenu] = useState(false);

            const resetGame = () => {
                if (confirm(currentLang === 'sw'
                    ? 'Una uhakika unataka kufuta maendeleo yote?'
                    : 'Are you sure you want to reset all progress?')) {
                    localStorage.removeItem('agrolinguo_save');
                    localStorage.removeItem('agrolinguo_research_stats');
                    localStorage.removeItem('agrolinguo_lang_selected');
                    window.location.reload();
                }
            };

            const installPWA = () => {
                if (window.deferredPrompt) {
                    window.deferredPrompt.prompt();
                    window.deferredPrompt.userChoice.then(choice => {
                        window.deferredPrompt = null;
                    });
                } else {
                    alert(currentLang === 'sw'
                        ? 'Tumia menyu ya kivinjari (‚ãÆ) ‚Üí "Ongeza kwenye Skrini ya Nyumbani"'
                        : 'Use browser menu (‚ãÆ) ‚Üí "Add to Home Screen"');
                }
                setShowHeaderMenu(false);
            };

            const Header = () => {
                const langInfo = window.AVAILABLE_LANGS?.[currentLang] || { flag: 'üåê', name: 'Language' };
                return (
                    <div className="bg-white shadow-md p-4 flex justify-between items-center relative">
                        <div className="flex items-center gap-2">
                            <span className="text-2xl">üåø</span>
                            <span className="font-bold text-green-700">AgroLinguo</span>
                            <button
                                onClick={changeLanguage}
                                className="ml-2 flex items-center gap-1 bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded-full text-sm transition"
                                title="Change Language"
                            >
                                <span>{langInfo.flag}</span>
                            </button>
                        </div>
                        <div className="flex items-center gap-2">
                            {/* Install & Menu button */}
                            <button
                                onClick={() => setShowHeaderMenu(!showHeaderMenu)}
                                className="flex items-center gap-1 bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded-full text-sm transition"
                                title="Menu"
                            >
                                <span>‚öôÔ∏è</span>
                            </button>
                            <div className="flex items-center gap-1 bg-red-100 px-2 py-1 rounded-full text-sm">
                                <span>‚ù§Ô∏è</span>
                                <span className="font-bold text-red-600">{hearts}</span>
                            </div>
                            <div className="flex items-center gap-1 bg-yellow-100 px-2 py-1 rounded-full text-sm">
                                <span>‚≠ê</span>
                                <span className="font-bold text-yellow-600">{totalXp}</span>
                            </div>
                        </div>

                        {/* Dropdown menu */}
                        {showHeaderMenu && (
                            <div className="absolute top-full right-4 mt-2 bg-white rounded-xl shadow-xl border z-50 overflow-hidden min-w-[200px]">
                                <button
                                    onClick={installPWA}
                                    className="w-full flex items-center gap-3 px-4 py-3 hover:bg-blue-50 transition text-left"
                                >
                                    <span className="text-xl">üì≤</span>
                                    <span className="font-semibold text-blue-700">{t('installApp')}</span>
                                </button>
                                <button
                                    onClick={resetGame}
                                    className="w-full flex items-center gap-3 px-4 py-3 hover:bg-red-50 transition text-left border-t"
                                >
                                    <span className="text-xl">üîÑ</span>
                                    <span className="font-semibold text-red-600">{currentLang === 'sw' ? 'Futa Maendeleo' : 'Reset Progress'}</span>
                                </button>
                                <button
                                    onClick={() => setShowHeaderMenu(false)}
                                    className="w-full flex items-center gap-3 px-4 py-3 hover:bg-gray-50 transition text-left border-t"
                                >
                                    <span className="text-xl">‚úï</span>
                                    <span className="text-gray-500">{currentLang === 'sw' ? 'Funga' : 'Close'}</span>
                                </button>
                            </div>
                        )}
                    </div>
                );
            };

            // === NEURAL PANEL COMPONENT ===
            const NeuralPanel = ({ compact = false }) => {
                const state = neuralState;
                if (!state.knowledgeState) return null;

                const phaseEmoji = {
                    'exploring': 'üîç',
                    'accelerating': 'üöÄ',
                    'consolidating': 'üìö',
                    'mastering': 'üèÜ',
                    'struggling': 'üí™'
                };

                const phaseText = {
                    'exploring': 'Exploring',
                    'accelerating': 'Accelerating!',
                    'consolidating': 'Consolidating',
                    'mastering': 'Mastering!',
                    'struggling': 'Keep Going!'
                };

                if (compact) {
                    return (
                        <div className="bg-gradient-to-r from-purple-500 to-indigo-600 rounded-2xl p-3 shadow-lg text-white">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-2">
                                    <span className="text-xl">üß†</span>
                                    <span className="font-bold text-sm">Neural</span>
                                </div>
                                <div className="flex items-center gap-1 bg-white/20 px-2 py-1 rounded-full">
                                    <span>{phaseEmoji[state.phase] || 'üîç'}</span>
                                    <span className="text-xs font-bold">{phaseText[state.phase] || state.phase}</span>
                                </div>
                                <div className="text-sm font-bold">{((state.avgKnowledge || 0) * 100).toFixed(0)}%</div>
                            </div>
                        </div>
                    );
                }

                return (
                    <div className="bg-gradient-to-r from-purple-500 to-indigo-600 rounded-2xl p-4 shadow-lg mb-4 text-white">
                        <div className="flex items-center justify-between mb-3">
                            <div className="flex items-center gap-2">
                                <span className="text-2xl">üß†</span>
                                <span className="font-bold">Neural Engine</span>
                            </div>
                            <div className="flex items-center gap-1 bg-white/20 px-3 py-1 rounded-full">
                                <span>{phaseEmoji[state.phase] || 'üîç'}</span>
                                <span className="text-sm font-bold">{phaseText[state.phase] || state.phase}</span>
                            </div>
                        </div>

                        {/* Knowledge bars */}
                        <div className="space-y-2 mb-3">
                            <div className="flex items-center gap-2">
                                <span className="text-xs w-20">Knowledge:</span>
                                <div className="flex-1 bg-white/20 rounded-full h-2 overflow-hidden">
                                    <div
                                        className="bg-green-400 h-full transition-all"
                                        style={{width: `${(state.avgKnowledge || 0) * 100}%`}}
                                    />
                                </div>
                                <span className="text-xs w-10">{((state.avgKnowledge || 0) * 100).toFixed(0)}%</span>
                            </div>
                            <div className="flex items-center gap-2">
                                <span className="text-xs w-20">Momentum:</span>
                                <div className="flex-1 bg-white/20 rounded-full h-2 overflow-hidden">
                                    <div
                                        className={`h-full transition-all ${state.momentum >= 0 ? 'bg-yellow-400' : 'bg-red-400'}`}
                                        style={{width: `${Math.abs(state.momentum || 0) * 50 + 50}%`}}
                                    />
                                </div>
                                <span className="text-xs w-10">{((state.momentum || 0) * 100).toFixed(0)}%</span>
                            </div>
                        </div>

                        {/* Weak/Strong skills */}
                        <div className="flex gap-2 text-xs">
                            <div className="flex-1 bg-white/10 rounded-lg p-2">
                                <div className="font-bold mb-1">üí™ Strong:</div>
                                {(state.strongSkills || []).slice(0, 2).map((s, i) => (
                                    <div key={i} className="truncate opacity-80">
                                        {window.NeuralEngine?.getSkillName(s.skillId)}
                                    </div>
                                ))}
                            </div>
                            <div className="flex-1 bg-white/10 rounded-lg p-2">
                                <div className="font-bold mb-1">üìñ Practice:</div>
                                {(state.weakSkills || []).slice(0, 2).map((s, i) => (
                                    <div key={i} className="truncate opacity-80">
                                        {window.NeuralEngine?.getSkillName(s.skillId)}
                                    </div>
                                ))}
                            </div>
                        </div>

                        <div className="mt-2 text-xs text-center opacity-60">
                            {state.interactionCount || 0} interactions ‚Ä¢ Offline AI
                        </div>
                    </div>
                );
            };

            // === BOTTOM TAB BAR COMPONENT ===
            const BottomTabBar = () => (
                <div className="fixed bottom-0 left-0 right-0 bg-white border-t shadow-lg safe-area-bottom">
                    <div className="flex justify-around items-center py-2">
                        <button
                            onClick={() => { setActiveTab('home'); setScreen('home'); }}
                            className={`flex flex-col items-center px-3 py-2 rounded-xl transition ${activeTab === 'home' ? 'text-green-600' : 'text-gray-400'}`}
                        >
                            <span className="text-xl">üè†</span>
                            <span className="text-xs font-bold mt-1">{t('home')}</span>
                        </button>
                        <button
                            onClick={() => { setActiveTab('learn'); setScreen('home'); }}
                            className={`flex flex-col items-center px-3 py-2 rounded-xl transition ${activeTab === 'learn' ? 'text-green-600' : 'text-gray-400'}`}
                        >
                            <span className="text-xl">üìö</span>
                            <span className="text-xs font-bold mt-1">{t('learn')}</span>
                        </button>
                        <button
                            onClick={() => { setActiveTab('skills'); setScreen('home'); }}
                            className={`flex flex-col items-center px-3 py-2 rounded-xl transition ${activeTab === 'skills' ? 'text-purple-600' : 'text-gray-400'}`}
                        >
                            <span className="text-xl">üß†</span>
                            <span className="text-xs font-bold mt-1">{t('skills')}</span>
                        </button>
                        <button
                            onClick={() => { setActiveTab('stats'); setScreen('home'); }}
                            className={`flex flex-col items-center px-3 py-2 rounded-xl transition ${activeTab === 'stats' ? 'text-blue-600' : 'text-gray-400'}`}
                        >
                            <span className="text-xl">üìä</span>
                            <span className="text-xs font-bold mt-1">{t('statistics')}</span>
                        </button>
                        <button
                            onClick={() => { setActiveTab('profile'); setScreen('home'); }}
                            className={`flex flex-col items-center px-3 py-2 rounded-xl transition ${activeTab === 'profile' ? 'text-green-600' : 'text-gray-400'}`}
                        >
                            <span className="text-xl">üë§</span>
                            <span className="text-xs font-bold mt-1">{t('profile')}</span>
                        </button>
                    </div>
                </div>
            );

            // === SKILLS SCREEN ===
            const SkillsScreen = () => {
                const state = neuralState;

                return (
                    <div className="min-h-screen bg-gradient-to-b from-purple-50 to-indigo-100 pb-20">
                        <div className="bg-gradient-to-r from-purple-500 to-indigo-600 shadow-md p-4">
                            <div className="flex items-center gap-2">
                                <span className="text-2xl">üß†</span>
                                <span className="font-bold text-white text-lg">Skills & Progress</span>
                            </div>
                        </div>

                        <div className="p-4 space-y-4">
                            {/* Learning Phase */}
                            <div className="bg-white rounded-2xl p-4 shadow-lg">
                                <h3 className="font-bold text-gray-800 mb-3 flex items-center gap-2">
                                    <span>üìä</span> Learning Phase
                                </h3>
                                <div className="flex items-center justify-center">
                                    <div className={`px-6 py-3 rounded-full font-bold text-lg ${
                                        state.phase === 'mastering' ? 'bg-yellow-100 text-yellow-700' :
                                        state.phase === 'accelerating' ? 'bg-green-100 text-green-700' :
                                        state.phase === 'consolidating' ? 'bg-blue-100 text-blue-700' :
                                        state.phase === 'struggling' ? 'bg-red-100 text-red-700' :
                                        'bg-purple-100 text-purple-700'
                                    }`}>
                                        {state.phase === 'exploring' && 'üîç Exploring'}
                                        {state.phase === 'accelerating' && 'üöÄ Accelerating'}
                                        {state.phase === 'consolidating' && 'üìö Consolidating'}
                                        {state.phase === 'mastering' && 'üèÜ Mastering'}
                                        {state.phase === 'struggling' && 'üí™ Keep Going'}
                                        {!state.phase && 'üîç Start Learning'}
                                    </div>
                                </div>
                            </div>

                            {/* Overall Progress */}
                            <div className="bg-white rounded-2xl p-4 shadow-lg">
                                <h3 className="font-bold text-gray-800 mb-3 flex items-center gap-2">
                                    <span>üìà</span> Overall Progress
                                </h3>
                                <div className="space-y-3">
                                    <div>
                                        <div className="flex justify-between text-sm mb-1">
                                            <span>Knowledge</span>
                                            <span className="font-bold">{((state.avgKnowledge || 0) * 100).toFixed(0)}%</span>
                                        </div>
                                        <div className="bg-gray-200 rounded-full h-3 overflow-hidden">
                                            <div className="bg-gradient-to-r from-green-400 to-green-600 h-full transition-all"
                                                style={{width: `${(state.avgKnowledge || 0) * 100}%`}} />
                                        </div>
                                    </div>
                                    <div>
                                        <div className="flex justify-between text-sm mb-1">
                                            <span>Momentum</span>
                                            <span className={`font-bold ${(state.momentum || 0) >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                                {((state.momentum || 0) * 100).toFixed(0)}%
                                            </span>
                                        </div>
                                        <div className="bg-gray-200 rounded-full h-3 overflow-hidden">
                                            <div className={`h-full transition-all ${(state.momentum || 0) >= 0 ? 'bg-gradient-to-r from-yellow-400 to-orange-500' : 'bg-red-400'}`}
                                                style={{width: `${Math.abs(state.momentum || 0) * 50 + 50}%`}} />
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Strong Skills */}
                            <div className="bg-white rounded-2xl p-4 shadow-lg">
                                <h3 className="font-bold text-gray-800 mb-3 flex items-center gap-2">
                                    <span>üí™</span> Strong Skills
                                </h3>
                                <div className="space-y-2">
                                    {(state.strongSkills || []).length === 0 ? (
                                        <div className="text-gray-400 text-center py-4">
                                            Answer questions to discover your strengths!
                                        </div>
                                    ) : (state.strongSkills || []).slice(0, 5).map((s, i) => {
                                        const masteryValue = Number(s.mastery);
                                        const masteryPercent = isNaN(masteryValue) ? 0 : Math.round(masteryValue * 100);
                                        return (
                                            <div key={i} className="flex items-center justify-between bg-green-50 rounded-lg p-3">
                                                <span className="font-medium">{window.NeuralEngine?.getSkillName(s.skillId)}</span>
                                                <span className="text-green-600 font-bold">{masteryPercent}%</span>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>

                            {/* Skills to Practice */}
                            <div className="bg-white rounded-2xl p-4 shadow-lg">
                                <h3 className="font-bold text-gray-800 mb-3 flex items-center gap-2">
                                    <span>üìñ</span> Skills to Practice
                                </h3>
                                <div className="space-y-2">
                                    {(state.weakSkills || []).length === 0 ? (
                                        <div className="text-gray-400 text-center py-4">
                                            Keep learning to see your improvement areas!
                                        </div>
                                    ) : (state.weakSkills || []).slice(0, 5).map((s, i) => {
                                        const masteryValue = Number(s.mastery);
                                        const masteryPercent = isNaN(masteryValue) ? 0 : Math.round(masteryValue * 100);
                                        return (
                                            <div key={i} className="flex items-center justify-between bg-orange-50 rounded-lg p-3">
                                                <span className="font-medium">{window.NeuralEngine?.getSkillName(s.skillId)}</span>
                                                <span className="text-orange-600 font-bold">{masteryPercent}%</span>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>

                            {/* Stats */}
                            <div className="bg-gradient-to-r from-purple-500 to-indigo-600 rounded-2xl p-4 shadow-lg text-white">
                                <h3 className="font-bold mb-3 flex items-center gap-2">
                                    <span>‚ö°</span> Neural Stats
                                </h3>
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="text-center">
                                        <div className="text-3xl font-bold">{state.interactionCount || 0}</div>
                                        <div className="text-xs opacity-80">Interactions</div>
                                    </div>
                                    <div className="text-center">
                                        <div className="text-3xl font-bold">{Object.keys(state.knowledgeState || {}).length}</div>
                                        <div className="text-xs opacity-80">Skills Tracked</div>
                                    </div>
                                </div>
                                <div className="mt-3 text-xs text-center opacity-60">
                                    üîí 100% Offline AI ‚Ä¢ No internet needed
                                </div>
                            </div>
                        </div>

                        <BottomTabBar />
                    </div>
                );
            };

            // === STATISTICS SCREEN (FOR RESEARCH) ===
            const StatisticsScreen = () => {
                const formatTime = (ms) => {
                    const seconds = Math.floor(ms / 1000);
                    const minutes = Math.floor(seconds / 60);
                    const hours = Math.floor(minutes / 60);

                    if (hours > 0) {
                        return `${hours}h ${minutes % 60}m`;
                    } else if (minutes > 0) {
                        return `${minutes}m ${seconds % 60}s`;
                    } else {
                        return `${seconds}s`;
                    }
                };

                const accuracy = researchStats.totalQuestions > 0
                    ? ((researchStats.correctAnswers / researchStats.totalQuestions) * 100).toFixed(1)
                    : 0;

                const avgResponseTime = researchStats.totalQuestions > 0
                    ? Math.round(researchStats.totalResponseTimeMs / researchStats.totalQuestions)
                    : 0;

                // Get last 7 days data for chart
                const getLast7Days = () => {
                    const days = [];
                    for (let i = 6; i >= 0; i--) {
                        const date = new Date();
                        date.setDate(date.getDate() - i);
                        const dateStr = date.toISOString().split('T')[0];
                        const dayStats = researchStats.dailyStats[dateStr] || { total: 0, correct: 0 };
                        days.push({
                            date: dateStr,
                            day: date.toLocaleDateString(currentLang === 'sw' ? 'sw-KE' : 'en-US', { weekday: 'short' }),
                            total: dayStats.total,
                            correct: dayStats.correct,
                            accuracy: dayStats.total > 0 ? (dayStats.correct / dayStats.total * 100) : 0
                        });
                    }
                    return days;
                };

                const last7Days = getLast7Days();
                const maxDaily = Math.max(...last7Days.map(d => d.total), 1);

                return (
                    <div className="min-h-screen bg-gradient-to-b from-blue-50 to-indigo-100 pb-20">
                        {/* Header */}
                        <div className="bg-gradient-to-r from-blue-500 to-indigo-600 shadow-md p-4">
                            <div className="flex items-center gap-2">
                                <span className="text-2xl">üìä</span>
                                <span className="font-bold text-white text-lg">{t('statistics')}</span>
                            </div>
                        </div>

                        <div className="p-4 space-y-4">
                            {researchStats.totalQuestions === 0 ? (
                                <div className="bg-white rounded-2xl p-8 shadow-lg text-center">
                                    <div className="text-6xl mb-4">üìö</div>
                                    <p className="text-gray-500">{t('noData')}</p>
                                </div>
                            ) : (
                                <>
                                    {/* Main Stats Grid */}
                                    <div className="bg-white rounded-2xl p-4 shadow-lg">
                                        <h3 className="font-bold text-gray-800 mb-4 flex items-center gap-2">
                                            <span>üìà</span> {t('allTime')}
                                        </h3>
                                        <div className="grid grid-cols-2 gap-3">
                                            <div className="bg-blue-50 rounded-xl p-3 text-center">
                                                <div className="text-2xl font-bold text-blue-600">{researchStats.totalQuestions}</div>
                                                <div className="text-xs text-gray-500">{t('totalQuestions')}</div>
                                            </div>
                                            <div className="bg-green-50 rounded-xl p-3 text-center">
                                                <div className="text-2xl font-bold text-green-600">{accuracy}%</div>
                                                <div className="text-xs text-gray-500">{t('accuracy')}</div>
                                            </div>
                                            <div className="bg-emerald-50 rounded-xl p-3 text-center">
                                                <div className="text-2xl font-bold text-emerald-600">{researchStats.correctAnswers}</div>
                                                <div className="text-xs text-gray-500">{t('correctAnswers')}</div>
                                            </div>
                                            <div className="bg-red-50 rounded-xl p-3 text-center">
                                                <div className="text-2xl font-bold text-red-500">{researchStats.incorrectAnswers}</div>
                                                <div className="text-xs text-gray-500">{t('incorrectAnswers')}</div>
                                            </div>
                                            <div className="bg-purple-50 rounded-xl p-3 text-center">
                                                <div className="text-2xl font-bold text-purple-600">{avgResponseTime}ms</div>
                                                <div className="text-xs text-gray-500">{t('avgResponseTime')}</div>
                                            </div>
                                            <div className="bg-orange-50 rounded-xl p-3 text-center">
                                                <div className="text-2xl font-bold text-orange-600">{formatTime(researchStats.totalSessionTimeMs)}</div>
                                                <div className="text-xs text-gray-500">{t('totalTime')}</div>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Last 7 Days Chart */}
                                    <div className="bg-white rounded-2xl p-4 shadow-lg">
                                        <h3 className="font-bold text-gray-800 mb-4 flex items-center gap-2">
                                            <span>üìÖ</span> {t('last7Days')}
                                        </h3>
                                        <div className="flex items-end justify-between h-32 gap-2">
                                            {last7Days.map((day, i) => (
                                                <div key={i} className="flex-1 flex flex-col items-center">
                                                    <div className="w-full flex flex-col items-center" style={{ height: '80px' }}>
                                                        <div
                                                            className="w-full bg-gradient-to-t from-blue-500 to-blue-400 rounded-t-lg transition-all"
                                                            style={{
                                                                height: `${(day.total / maxDaily) * 100}%`,
                                                                minHeight: day.total > 0 ? '4px' : '0'
                                                            }}
                                                        />
                                                    </div>
                                                    <div className="text-xs text-gray-500 mt-1">{day.day}</div>
                                                    <div className="text-xs font-bold text-gray-700">{day.total}</div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    {/* Module Stats */}
                                    <div className="bg-white rounded-2xl p-4 shadow-lg">
                                        <h3 className="font-bold text-gray-800 mb-4 flex items-center gap-2">
                                            <span>üìö</span> {t('moduleStats')}
                                        </h3>
                                        <div className="space-y-3">
                                            {modules.map(module => {
                                                const moduleStats = researchStats.moduleStats[`module_${module.id}`];
                                                if (!moduleStats || moduleStats.total === 0) return null;

                                                const moduleAccuracy = (moduleStats.correct / moduleStats.total * 100).toFixed(0);
                                                return (
                                                    <div key={module.id} className="flex items-center gap-3">
                                                        <span className="text-2xl">{module.icon}</span>
                                                        <div className="flex-1">
                                                            <div className="flex justify-between items-center mb-1">
                                                                <span className="font-medium text-sm">{lt(module.name)}</span>
                                                                <span className="text-sm text-gray-500">{moduleStats.total} {t('questionsAnswered').toLowerCase()}</span>
                                                            </div>
                                                            <div className="bg-gray-200 rounded-full h-2 overflow-hidden">
                                                                <div
                                                                    className={`bg-gradient-to-r ${module.color} h-full`}
                                                                    style={{ width: `${moduleAccuracy}%` }}
                                                                />
                                                            </div>
                                                            <div className="text-xs text-gray-400 mt-1">{moduleAccuracy}% {t('accuracy').toLowerCase()}</div>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>

                                    {/* Export Section */}
                                    <div className="bg-gradient-to-r from-blue-500 to-indigo-600 rounded-2xl p-4 shadow-lg text-white">
                                        <h3 className="font-bold mb-3 flex items-center gap-2">
                                            <span>üì§</span> {t('researchExport')}
                                        </h3>
                                        <p className="text-sm opacity-80 mb-4">
                                            {currentLang === 'sw'
                                                ? 'Hamisha data kwa uchambuzi wa kisayansi'
                                                : 'Export data for scientific analysis'}
                                        </p>
                                        <div className="grid grid-cols-2 gap-3">
                                            <button
                                                onClick={exportStatsAsJSON}
                                                className="bg-white/20 hover:bg-white/30 py-3 px-4 rounded-xl font-bold flex items-center justify-center gap-2 transition"
                                            >
                                                <span>üìã</span> {t('exportJson')}
                                            </button>
                                            <button
                                                onClick={exportStatsAsCSV}
                                                className="bg-white/20 hover:bg-white/30 py-3 px-4 rounded-xl font-bold flex items-center justify-center gap-2 transition"
                                            >
                                                <span>üìä</span> {t('exportCsv')}
                                            </button>
                                        </div>

                                        {/* Additional info for researchers */}
                                        <div className="mt-4 pt-4 border-t border-white/20 text-xs opacity-70">
                                            <div className="grid grid-cols-2 gap-2">
                                                <div>Start: {new Date(researchStats.startDate).toLocaleDateString()}</div>
                                                <div>Answers: {researchStats.answerHistory.length}</div>
                                                <div>Sessions: {researchStats.sessions.length}</div>
                                                <div>Language: {currentLang.toUpperCase()}</div>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Reset Button */}
                                    <button
                                        onClick={resetResearchStats}
                                        className="w-full bg-white rounded-2xl p-4 shadow-lg text-red-500 font-bold flex items-center justify-center gap-2"
                                    >
                                        <span>üóëÔ∏è</span> {t('resetStats')}
                                    </button>
                                </>
                            )}
                        </div>

                        <BottomTabBar />
                    </div>
                );
            };

            // === PROFILE SCREEN ===
            const ProfileScreen = () => (
                <div className="min-h-screen bg-gradient-to-b from-green-50 to-green-100 pb-20">
                    <Header />
                    <div className="p-4">
                        <div className="bg-white rounded-2xl p-6 shadow-lg mb-4">
                            <div className="flex items-center gap-4 mb-6">
                                <div className="relative">
                                    <div className="w-20 h-20 bg-gradient-to-r from-green-400 to-green-600 rounded-full flex items-center justify-center text-4xl">
                                        üßë‚Äçüåæ
                                    </div>
                                    <div className="absolute -bottom-1 -right-1 bg-yellow-400 rounded-full px-2 py-1 text-sm font-bold">
                                        {playerLevel}
                                    </div>
                                </div>
                                <div className="flex-1">
                                    <div className="font-bold text-xl">{t('farmer')}</div>
                                    <div className="text-gray-500">{t('level')} {playerLevel}</div>
                                </div>
                            </div>

                            {/* Stats */}
                            <div className="grid grid-cols-3 gap-4 text-center">
                                <div className="bg-yellow-50 rounded-xl p-3">
                                    <div className="text-2xl font-bold text-yellow-600">{totalXp}</div>
                                    <div className="text-xs text-gray-500">{t('totalXp')}</div>
                                </div>
                                <div className="bg-orange-50 rounded-xl p-3">
                                    <div className="text-2xl font-bold text-orange-600">{streak}</div>
                                    <div className="text-xs text-gray-500">{t('streak')} üî•</div>
                                </div>
                                <div className="bg-green-50 rounded-xl p-3">
                                    <div className="text-2xl font-bold text-green-600">{Object.keys(levelProgress).length}</div>
                                    <div className="text-xs text-gray-500">{t('completed')}</div>
                                </div>
                            </div>
                        </div>

                        {/* XP Progress */}
                        <div className="bg-white rounded-2xl p-4 shadow-lg mb-4">
                            <div className="flex justify-between items-center mb-2">
                                <span className="font-bold">{t('levelProgress')}</span>
                                <span className="text-sm text-gray-500">{totalXp % 100}/100 XP</span>
                            </div>
                            <div className="bg-gray-200 rounded-full h-3 overflow-hidden">
                                <div className="bg-gradient-to-r from-green-400 to-green-600 h-full transition-all"
                                    style={{width: `${(totalXp % 100)}%`}} />
                            </div>
                            <div className="text-xs text-gray-400 mt-2 text-center">
                                {100 - (totalXp % 100)} XP to Level {playerLevel + 1}
                            </div>
                        </div>

                        {/* Daily Goal */}
                        <div className="bg-white rounded-2xl p-4 shadow-lg">
                            <div className="flex justify-between items-center mb-2">
                                <span className="font-bold">{t('dailyGoal')}</span>
                                <span className="text-sm text-gray-500">{dailyXp}/{dailyGoal} XP</span>
                            </div>
                            <div className="bg-gray-200 rounded-full h-3 overflow-hidden">
                                <div className="bg-gradient-to-r from-yellow-400 to-orange-500 h-full transition-all"
                                    style={{width: `${Math.min((dailyXp / dailyGoal) * 100, 100)}%`}} />
                            </div>
                        </div>

                        {/* Download / Install Section */}
                        <div className="bg-white rounded-2xl p-4 shadow-lg mt-4">
                            <h3 className="font-bold text-lg mb-3">üì± {t('downloadApp')}</h3>
                            <div className="space-y-3">
                                <a
                                    href="agrolinguo-offline.zip"
                                    download="AgroLinguo.zip"
                                    className="flex items-center gap-3 p-3 bg-green-50 rounded-xl hover:bg-green-100 transition"
                                >
                                    <span className="text-2xl">üì•</span>
                                    <div>
                                        <div className="font-bold text-green-700">{t('downloadApp')}</div>
                                        <div className="text-xs text-gray-500">{t('downloadDesc')}</div>
                                    </div>
                                </a>
                                <button
                                    onClick={() => {
                                        if (window.deferredPrompt) {
                                            window.deferredPrompt.prompt();
                                            window.deferredPrompt.userChoice.then(choice => {
                                                window.deferredPrompt = null;
                                            });
                                        } else {
                                            alert(currentLang === 'sw'
                                                ? 'Tumia menyu ya kivinjari kuongeza kwenye skrini ya nyumbani'
                                                : 'Use browser menu to add to home screen');
                                        }
                                    }}
                                    className="flex items-center gap-3 p-3 bg-blue-50 rounded-xl hover:bg-blue-100 transition w-full text-left"
                                >
                                    <span className="text-2xl">üì≤</span>
                                    <div>
                                        <div className="font-bold text-blue-700">{t('installApp')}</div>
                                        <div className="text-xs text-gray-500">{t('installDesc')}</div>
                                    </div>
                                </button>
                            </div>
                        </div>
                    </div>

                    <BottomTabBar />
                </div>
            );

            // Home screen with tabs
            const HomeScreen = () => {
                // If skills, stats, or profile tab selected, show those
                if (activeTab === 'skills') return <SkillsScreen />;
                if (activeTab === 'stats') return <StatisticsScreen />;
                if (activeTab === 'profile') return <ProfileScreen />;

                return (
                    <div className="min-h-screen bg-gradient-to-b from-green-50 to-green-100 pb-20">
                        <Header />

                        {/* Profile and level */}
                        <div className="p-4">
                            {/* SESSION TIMER - isolated component, no parent re-renders */}
                            <SessionTimer />

                            {/* LIVE STATS PANEL - visible for research photos */}
                            <div className="bg-gradient-to-r from-blue-500 to-indigo-600 rounded-2xl p-3 shadow-lg mb-4 text-white" onClick={() => setActiveTab('stats')}>
                                <div className="flex items-center justify-between mb-2">
                                    <div className="flex items-center gap-2">
                                        <span className="text-lg">üìä</span>
                                        <span className="font-bold text-sm">Live Stats</span>
                                    </div>
                                    <span className="text-xs opacity-70">{new Date().toLocaleDateString()}</span>
                                </div>
                                <div className="grid grid-cols-4 gap-2 text-center">
                                    <div className="bg-white/20 rounded-lg p-2">
                                        <div className="text-lg font-bold">{researchStats.totalQuestions}</div>
                                        <div className="text-[10px] opacity-80">Questions</div>
                                    </div>
                                    <div className="bg-white/20 rounded-lg p-2">
                                        <div className="text-lg font-bold text-green-300">{researchStats.correctAnswers}</div>
                                        <div className="text-[10px] opacity-80">Correct</div>
                                    </div>
                                    <div className="bg-white/20 rounded-lg p-2">
                                        <div className="text-lg font-bold">
                                            {researchStats.totalQuestions > 0
                                                ? Math.round(researchStats.correctAnswers / researchStats.totalQuestions * 100)
                                                : 0}%
                                        </div>
                                        <div className="text-[10px] opacity-80">Accuracy</div>
                                    </div>
                                    <div className="bg-white/20 rounded-lg p-2">
                                        <div className="text-lg font-bold">
                                            {researchStats.totalQuestions > 0
                                                ? Math.round(researchStats.totalResponseTimeMs / researchStats.totalQuestions / 1000 * 10) / 10
                                                : 0}s
                                        </div>
                                        <div className="text-[10px] opacity-80">Avg Time</div>
                                    </div>
                                </div>
                            </div>

                            {/* Compact Neural Panel on home */}
                            {activeTab === 'home' && neuralState.knowledgeState && (
                                <div className="mb-4" onClick={() => setActiveTab('skills')}>
                                    <NeuralPanel compact={true} />
                                </div>
                            )}

                            <div className="bg-white rounded-2xl p-4 shadow-lg mb-4">
                                <div className="flex items-center gap-4">
                                    <div className="relative">
                                        <div className="w-16 h-16 bg-gradient-to-r from-green-400 to-green-600 rounded-full flex items-center justify-center text-3xl">
                                            üßë‚Äçüåæ
                                        </div>
                                        <div className="absolute -bottom-1 -right-1 bg-yellow-400 rounded-full px-2 py-0.5 text-xs font-bold">
                                            {playerLevel}
                                        </div>
                                    </div>
                                    <div className="flex-1">
                                        <div className="font-bold text-lg">{t('farmer')}</div>
                                        <div className="text-sm text-gray-500">{t('level')} {playerLevel}</div>
                                        <div className="mt-1 bg-gray-200 rounded-full h-2 overflow-hidden">
                                            <div
                                                className="bg-gradient-to-r from-green-400 to-green-600 h-full transition-all duration-500"
                                                style={{width: `${((totalXp % 100) / 100) * 100}%`}}
                                            />
                                        </div>
                                        <div className="text-xs text-gray-400 mt-1">{totalXp % 100}/100 XP to next level</div>
                                    </div>
                                </div>
                            </div>

                            {/* Daily goal */}
                            <div className="bg-white rounded-2xl p-4 shadow-lg mb-4">
                                <div className="flex justify-between items-center mb-2">
                                    <span className="font-bold">{t('dailyGoal')}</span>
                                    <span className="text-sm text-gray-500">{dailyXp}/{dailyGoal} XP</span>
                                </div>
                                <div className="bg-gray-200 rounded-full h-3 overflow-hidden">
                                    <div
                                        className="bg-gradient-to-r from-yellow-400 to-orange-500 h-full transition-all duration-500"
                                        style={{width: `${Math.min((dailyXp / dailyGoal) * 100, 100)}%`}}
                                    />
                                </div>
                            </div>

                            {/* Modules - Duolingo style big icons with progress */}
                            <div className="space-y-4">
                                <h2 className="font-bold text-xl text-gray-800">{t('courses')}</h2>
                                {modules.map(module => {
                                    // Calculate progress for this module
                                    const completedLevels = Array.from({length: module.levels}, (_, i) => {
                                        const levelKey = `${module.id}-${i + 1}`;
                                        return levelProgress[levelKey] >= 1 ? 1 : 0;
                                    }).reduce((a, b) => a + b, 0);

                                    const totalStars = Array.from({length: module.levels}, (_, i) => {
                                        const levelKey = `${module.id}-${i + 1}`;
                                        return levelProgress[levelKey] || 0;
                                    }).reduce((a, b) => a + b, 0);

                                    const progressPercent = (completedLevels / module.levels) * 100;

                                    return (
                                        <div
                                            key={module.id}
                                            onClick={() => {setSelectedModule(module.id); setScreen('levels');}}
                                            className={`bg-gradient-to-r ${module.color} p-5 rounded-3xl shadow-lg cursor-pointer transform transition hover:scale-[1.02] active:scale-[0.98]`}
                                        >
                                            <div className="flex items-center gap-4">
                                                <div className="w-20 h-20 bg-white/30 rounded-2xl flex items-center justify-center shadow-inner relative">
                                                    <span className="text-6xl">{module.icon}</span>
                                                    {completedLevels === module.levels && (
                                                        <div className="absolute -top-2 -right-2 bg-yellow-400 rounded-full w-8 h-8 flex items-center justify-center text-lg shadow-lg">
                                                            üèÜ
                                                        </div>
                                                    )}
                                                </div>
                                                <div className="flex-1 text-white">
                                                    <div className="font-bold text-xl">{lt(module.name)}</div>
                                                    <div className="text-sm opacity-90 mt-1">{lt(module.description)}</div>

                                                    {/* Progress bar */}
                                                    <div className="mt-3">
                                                        <div className="flex justify-between text-xs mb-1">
                                                            <span className="opacity-80">{completedLevels}/{module.levels} {t('levels')}</span>
                                                            <span className="flex items-center gap-1">
                                                                <span className="text-yellow-300">‚≠ê</span>
                                                                <span>{totalStars}/{module.levels * 3}</span>
                                                            </span>
                                                        </div>
                                                        <div className="bg-white/20 rounded-full h-2 overflow-hidden">
                                                            <div
                                                                className="bg-white h-full transition-all duration-500 rounded-full"
                                                                style={{width: `${progressPercent}%`}}
                                                            />
                                                        </div>
                                                    </div>
                                                </div>
                                                <div className="text-white text-3xl opacity-80">‚Üí</div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>

                        <BottomTabBar />
                    </div>
                );
            };

            // Levels screen - Duolingo style
            const LevelsScreen = () => {
                const module = modules.find(m => m.id === selectedModule);

                // Calculate progress for this module
                const completedLevels = Array.from({length: module.levels}, (_, i) => {
                    const levelKey = `${module.id}-${i + 1}`;
                    return levelProgress[levelKey] >= 1 ? 1 : 0;
                }).reduce((a, b) => a + b, 0);

                const totalStars = Array.from({length: module.levels}, (_, i) => {
                    const levelKey = `${module.id}-${i + 1}`;
                    return levelProgress[levelKey] || 0;
                }).reduce((a, b) => a + b, 0);

                const progressPercent = (completedLevels / module.levels) * 100;

                return (
                    <div className="min-h-screen bg-gradient-to-b from-green-50 to-green-100">
                        {/* Header with big module icon and progress */}
                        <div className={`bg-gradient-to-r ${module.color} shadow-lg p-5`}>
                            <div className="flex items-center gap-4 mb-4">
                                <button
                                    onClick={() => setScreen('home')}
                                    className="text-3xl text-white/80 hover:text-white"
                                >
                                    ‚Üê
                                </button>
                                <div className="w-16 h-16 bg-white/30 rounded-2xl flex items-center justify-center relative">
                                    <span className="text-5xl">{module.icon}</span>
                                    {completedLevels === module.levels && (
                                        <div className="absolute -top-2 -right-2 bg-yellow-400 rounded-full w-7 h-7 flex items-center justify-center text-sm shadow-lg">
                                            üèÜ
                                        </div>
                                    )}
                                </div>
                                <div className="text-white flex-1">
                                    <div className="font-bold text-2xl">{lt(module.name)}</div>
                                    <div className="text-sm opacity-80">{lt(module.description)}</div>
                                </div>
                            </div>

                            {/* Progress stats */}
                            <div className="flex justify-between items-center text-white text-sm mb-2">
                                <span className="opacity-90">{completedLevels}/{module.levels} levels completed</span>
                                <span className="flex items-center gap-1">
                                    <span className="text-yellow-300 text-lg">‚≠ê</span>
                                    <span className="font-bold">{totalStars}/{module.levels * 3}</span>
                                </span>
                            </div>
                            <div className="bg-white/20 rounded-full h-3 overflow-hidden">
                                <div
                                    className="bg-white h-full transition-all duration-500 rounded-full"
                                    style={{width: `${progressPercent}%`}}
                                />
                            </div>
                        </div>

                        {/* Level grid - bigger buttons */}
                        <div className="p-5">
                            <div className="grid grid-cols-4 gap-4">
                                {Array.from({length: module.levels}, (_, i) => {
                                    const levelNum = i + 1;
                                    const levelKey = `${module.id}-${levelNum}`;
                                    const stars = levelProgress[levelKey] || 0;
                                    const prevLevelKey = `${module.id}-${levelNum - 1}`;
                                    const isUnlocked = levelNum === 1 || (levelProgress[prevLevelKey] || 0) >= 1;

                                    return (
                                        <button
                                            key={levelNum}
                                            onClick={() => isUnlocked && startLevel(module.id, levelNum)}
                                            disabled={!isUnlocked}
                                            className={`aspect-square rounded-3xl flex flex-col items-center justify-center shadow-lg transition transform hover:scale-105 active:scale-95 ${
                                                isUnlocked
                                                    ? `bg-gradient-to-br ${module.color} text-white shadow-[0_6px_0_rgba(0,0,0,0.2)]`
                                                    : 'bg-gray-200 text-gray-400 shadow-[0_6px_0_#d1d5db]'
                                            }`}
                                        >
                                            {isUnlocked ? (
                                                <>
                                                    <span className="font-bold text-3xl">{levelNum}</span>
                                                    <div className="flex mt-2 gap-0.5">
                                                        {[1,2,3].map(s => (
                                                            <span key={s} className={`text-base ${s <= stars ? 'text-yellow-300' : 'text-white/30'}`}>
                                                                ‚≠ê
                                                            </span>
                                                        ))}
                                                    </div>
                                                </>
                                            ) : (
                                                <span className="text-4xl">üîí</span>
                                            )}
                                        </button>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                );
            };

            // Quiz obrazovka
            const QuizScreen = () => {
                const questions = getQuestionsForLevel(selectedModule, selectedLevel);
                const question = questions[currentQuestion];
                const module = modules.find(m => m.id === selectedModule);

                if (!question) {
                    return (
                        <div className="h-screen flex items-center justify-center">
                            <div className="text-center">
                                <div className="text-6xl mb-4">üìö</div>
                                <div className="text-xl font-bold text-gray-600">Questions for this level are not available</div>
                                <button
                                    onClick={() => setScreen('levels')}
                                    className="mt-4 bg-green-500 text-white px-6 py-2 rounded-full"
                                >
                                    Back
                                </button>
                            </div>
                        </div>
                    );
                }

                const isCorrect = showAnswer && question.options[selectedAnswer]?.isCorrect;

                return (
                    <div className="h-screen bg-gradient-to-b from-green-50 to-green-100 flex flex-col overflow-hidden relative">
                        {/* Header s progress barem */}
                        <div className="bg-white shadow-sm px-4 py-2 flex-shrink-0">
                            {/* Timer row - isolated component */}
                            <MiniTimer />
                            <div className="flex items-center justify-between mb-2">
                                <button onClick={() => setScreen('levels')} className="close-btn text-2xl p-2 -ml-2">‚úï</button>
                                {/* Mini stats for research - visible during quiz */}
                                <div className="flex items-center gap-1 bg-blue-100 px-2 py-1 rounded-full text-xs">
                                    <span>üìä</span>
                                    <span className="font-bold text-blue-600">{researchStats.totalQuestions}</span>
                                    <span className="text-blue-400">|</span>
                                    <span className="font-bold text-green-600">
                                        {researchStats.totalQuestions > 0
                                            ? Math.round(researchStats.correctAnswers / researchStats.totalQuestions * 100)
                                            : 0}%
                                    </span>
                                </div>
                                <div className="hearts-display flex items-center">
                                    {Array.from({length: 5}, (_, i) => (
                                        <span key={i} className={`text-xl ${i < hearts ? '' : 'opacity-30'}`}>‚ù§Ô∏è</span>
                                    ))}
                                </div>
                            </div>
                            <div className="progress-bar bg-gray-200 rounded-full h-3 overflow-hidden">
                                <div
                                    className={`bg-gradient-to-r ${module.color} h-full transition-all duration-500`}
                                    style={{width: `${((currentQuestion + 1) / questions.length) * 100}%`}}
                                />
                            </div>
                        </div>

                        {/* Karta s ot√°zkou */}
                        <div className="mobile-container px-4 py-3 flex-shrink-0">
                            <div className="question-card bg-white rounded-2xl p-5 shadow-lg">
                                <div className="flex items-start gap-4">
                                    <span className="question-icon text-4xl">{module.icon}</span>
                                    <h2 className="question-text text-xl font-bold text-gray-800 flex-1 leading-snug">
                                        {question.question}
                                    </h2>
                                </div>
                            </div>
                        </div>

                        {/* Odpovƒõdi - velk√© tlaƒç√≠tka pro mobil */}
                        <div className="flex-1 px-4 overflow-y-auto pb-4">
                            <div className="answers-container flex flex-col gap-3">
                                {question.options.map((option, index) => {
                                    let stateClass = '';
                                    let extraClass = '';

                                    if (showAnswer) {
                                        if (option.isCorrect) {
                                            stateClass = 'correct';
                                            extraClass = 'bg-green-100 border-green-500';
                                        } else if (index === selectedAnswer && !option.isCorrect) {
                                            stateClass = 'wrong';
                                            extraClass = 'bg-red-100 border-red-500';
                                        } else {
                                            extraClass = 'bg-gray-100 opacity-50 border-gray-300';
                                        }
                                    } else if (index === selectedAnswer) {
                                        stateClass = 'selected';
                                    }

                                    return (
                                        <button
                                            key={index}
                                            onClick={() => handleAnswer(index)}
                                            disabled={showAnswer}
                                            className={`btn-answer w-full min-h-[64px] py-4 px-5 rounded-2xl bg-white border-2 border-gray-200 text-left ${stateClass} ${extraClass}`}
                                        >
                                            <div className="flex items-center gap-4">
                                                {option.icon && <span className="answer-icon text-3xl">{option.icon}</span>}
                                                <span className="answer-text font-bold text-gray-800 flex-1 text-lg">{option.text}</span>
                                                {showAnswer && option.isCorrect && (
                                                    <span className="text-green-500 text-3xl">‚úì</span>
                                                )}
                                                {showAnswer && index === selectedAnswer && !option.isCorrect && (
                                                    <span className="text-red-500 text-3xl">‚úó</span>
                                                )}
                                            </div>
                                        </button>
                                    );
                                })}
                            </div>
                        </div>

                        {/* Spodn√≠ feedback panel - always mounted, uses CSS transition */}
                        <div
                            className={`feedback-panel px-5 py-6 rounded-t-3xl ${showAnswer ? 'visible' : 'hidden'} ${showAnswer && isCorrect ? 'bg-green-100' : 'bg-red-100'}`}
                            style={{boxShadow: showAnswer ? '0 -10px 40px rgba(0,0,0,0.2)' : 'none'}}
                        >
                            <div className="flex items-start gap-4 mb-5">
                                <div className="feedback-emoji text-5xl">
                                    {showAnswer ? (isCorrect ? 'üéâ' : 'üò¢') : 'üéâ'}
                                </div>
                                <div className="flex-1">
                                    <div className={`feedback-title font-bold text-2xl ${showAnswer && isCorrect ? 'text-green-700' : 'text-red-700'}`}>
                                        {showAnswer ? (isCorrect ? t('excellent') : t('notQuite')) : ' '}
                                    </div>
                                    <div className="feedback-text text-base text-gray-700 mt-1">
                                        {showAnswer && question ? question.explanation : ' '}
                                    </div>
                                </div>
                            </div>
                            <button
                                onClick={showAnswer ? nextQuestion : undefined}
                                disabled={!showAnswer}
                                className={`continue-btn w-full min-h-[56px] py-4 rounded-2xl font-bold text-xl text-white ${
                                    !showAnswer || isCorrect
                                        ? 'bg-green-500 shadow-[0_5px_0_#16a34a]'
                                        : 'bg-red-500 shadow-[0_5px_0_#dc2626]'
                                }`}
                                style={{
                                    transform: 'translateY(0)',
                                    opacity: 1
                                }}
                            >
                                {showAnswer
                                    ? (currentQuestion + 1 >= questions.length ? `üèÜ ${t('finish')}` : `‚Üí ${t('continue')}`)
                                    : `‚Üí ${t('continue')}`
                                }
                            </button>
                        </div>
                    </div>
                );
            };

            // Konfety komponenta
            const Confetti = () => {
                const colors = ['#ff6b6b', '#4ecdc4', '#ffe66d', '#95e1d3', '#f38181', '#aa96da', '#fcbad3'];
                const confettiPieces = Array.from({length: 50}, (_, i) => ({
                    id: i,
                    left: Math.random() * 100,
                    delay: Math.random() * 2,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    size: Math.random() * 10 + 5
                }));

                return (
                    <div className="fixed inset-0 pointer-events-none overflow-hidden z-50">
                        {confettiPieces.map(piece => (
                            <div
                                key={piece.id}
                                className="confetti"
                                style={{
                                    left: `${piece.left}%`,
                                    animationDelay: `${piece.delay}s`,
                                    backgroundColor: piece.color,
                                    width: `${piece.size}px`,
                                    height: `${piece.size}px`,
                                    borderRadius: Math.random() > 0.5 ? '50%' : '0'
                                }}
                            />
                        ))}
                    </div>
                );
            };

            // Obrazovka v√Ωsledk≈Ø
            const ResultsScreen = () => {
                const questions = getQuestionsForLevel(selectedModule, selectedLevel);
                const percentage = Math.round((score / questions.length) * 100);
                const stars = percentage >= 90 ? 3 : percentage >= 70 ? 2 : percentage >= 50 ? 1 : 0;
                const module = modules.find(m => m.id === selectedModule);
                const isWin = stars >= 1;

                // P≈ôej√≠t na dal≈°√≠ level
                const goToNextLevel = () => {
                    if (isWin && selectedLevel < module.levels) {
                        startLevel(selectedModule, selectedLevel + 1);
                    } else {
                        startLevel(selectedModule, selectedLevel);
                    }
                };

                return (
                    <div className="h-screen bg-gradient-to-b from-green-50 to-green-100 flex flex-col overflow-hidden">
                        {/* Konfety p≈ôi v√Ωh≈ôe */}
                        {isWin && <Confetti />}

                        {/* Hlavn√≠ obsah */}
                        <div className="flex-1 flex flex-col items-center justify-center p-4 relative z-10">
                            <div className={`text-8xl mb-2 ${isWin ? 'star-burst' : ''}`}>
                                {stars >= 2 ? 'üèÜ' : stars === 1 ? 'üéâ' : 'üí™'}
                            </div>

                            <h2 className="text-3xl font-bold text-gray-800 mb-4">
                                {stars >= 2 ? t('excellent') : stars === 1 ? t('goodJob') : t('tryAgain')}
                            </h2>

                            <div className="flex justify-center gap-4 mb-6">
                                {[1,2,3].map(s => (
                                    <span
                                        key={s}
                                        className={`text-5xl ${s <= stars ? 'star-burst' : 'opacity-20'}`}
                                        style={{animationDelay: `${0.3 + s * 0.15}s`}}
                                    >
                                        ‚≠ê
                                    </span>
                                ))}
                            </div>

                            <div className="bg-white/80 backdrop-blur rounded-2xl p-5 shadow-lg">
                                <div className="grid grid-cols-2 gap-8">
                                    <div className="text-center">
                                        <div className="text-4xl font-bold text-green-600">{score}/{questions.length}</div>
                                        <div className="text-sm text-gray-500 mt-1">{t('correct')}</div>
                                    </div>
                                    <div className="text-center">
                                        <div className="text-4xl font-bold text-yellow-600">+{xp + (stars * 5)}</div>
                                        <div className="text-sm text-gray-500 mt-1">XP</div>
                                    </div>
                                </div>
                            </div>

                            {/* RESEARCH STATS SUMMARY - for photos */}
                            <div className="bg-gradient-to-r from-blue-500 to-indigo-600 rounded-2xl p-4 shadow-lg mt-4 text-white">
                                <div className="flex items-center justify-between mb-3">
                                    <div className="flex items-center gap-2">
                                        <span>üìä</span>
                                        <span className="font-bold">Research Data</span>
                                    </div>
                                    <span className="text-xs opacity-70">{new Date().toLocaleString()}</span>
                                </div>
                                <div className="grid grid-cols-3 gap-2 text-center text-sm">
                                    <div className="bg-white/20 rounded-lg p-2">
                                        <div className="font-bold text-xl">{researchStats.totalQuestions}</div>
                                        <div className="text-[10px] opacity-80">Total Qs</div>
                                    </div>
                                    <div className="bg-white/20 rounded-lg p-2">
                                        <div className="font-bold text-xl text-green-300">
                                            {researchStats.totalQuestions > 0
                                                ? Math.round(researchStats.correctAnswers / researchStats.totalQuestions * 100)
                                                : 0}%
                                        </div>
                                        <div className="text-[10px] opacity-80">Accuracy</div>
                                    </div>
                                    <div className="bg-white/20 rounded-lg p-2">
                                        <div className="font-bold text-xl">
                                            {researchStats.totalQuestions > 0
                                                ? (researchStats.totalResponseTimeMs / researchStats.totalQuestions / 1000).toFixed(1)
                                                : 0}s
                                        </div>
                                        <div className="text-[10px] opacity-80">Avg Time</div>
                                    </div>
                                </div>
                                <div className="mt-2 pt-2 border-t border-white/20 text-[10px] opacity-70 flex justify-between">
                                    <span>Module: {module.id} | Level: {selectedLevel}</span>
                                    <span>Lang: {currentLang.toUpperCase()}</span>
                                </div>
                            </div>
                        </div>

                        {/* Buttons fixed at bottom */}
                        <div className="p-4 bg-white border-t shadow-lg">
                            <button
                                onClick={goToNextLevel}
                                className={`w-full py-5 rounded-2xl font-bold text-xl text-white shadow-lg mb-3 bg-gradient-to-r ${module.color}`}
                            >
                                {isWin ? (selectedLevel < module.levels ? `üöÄ ${t('nextLevel')}` : `üîÑ ${t('playAgain')}`) : `üîÑ ${t('tryAgain')}`}
                            </button>
                            <button
                                onClick={() => setScreen('levels')}
                                className="w-full py-3 rounded-xl font-bold text-gray-600 bg-gray-100"
                            >
                                {t('backToOverview')}
                            </button>
                        </div>
                    </div>
                );
            };

            // Game Over screen
            const GameOverScreen = () => (
                <div className="h-screen bg-gradient-to-b from-red-50 to-red-100 flex flex-col items-center justify-center p-4">
                    <div className="bg-white rounded-3xl p-8 shadow-2xl text-center max-w-sm w-full">
                        <div className="text-6xl mb-4">üíî</div>
                        <h2 className="text-2xl font-bold text-gray-800 mb-2">{t('outOfHearts')}</h2>
                        <p className="text-gray-500 mb-6">{t('dontGiveUp')}</p>

                        <div className="space-y-3">
                            <button
                                onClick={() => { refillHearts(); startLevel(selectedModule, selectedLevel); }}
                                className="w-full py-4 rounded-xl font-bold text-lg bg-gradient-to-r from-green-500 to-green-600 text-white shadow-lg"
                            >
                                ‚ù§Ô∏è {t('tryAgain')}
                            </button>
                            <button
                                onClick={() => setScreen('home')}
                                className="w-full bg-gray-200 text-gray-700 py-3 rounded-xl font-bold"
                            >
                                {t('backHome')}
                            </button>
                        </div>
                    </div>
                </div>
            );

            // Render podle aktu√°ln√≠ obrazovky
            // First show language selector if not selected yet
            if (showLangSelect) {
                return <LanguageSelectScreen />;
            }

            switch (screen) {
                case 'home': return <HomeScreen />;
                case 'levels': return <LevelsScreen />;
                case 'quiz': return <QuizScreen />;
                case 'results': return <ResultsScreen />;
                case 'gameover': return <GameOverScreen />;
                default: return <HomeScreen />;
            }
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>

    <!-- Service Worker & PWA Install -->
    <script>
        // Capture PWA install prompt
        window.deferredPrompt = null;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            window.deferredPrompt = e;
            console.log('PWA install prompt captured');
        });

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => console.log('SW registered:', reg.scope))
                    .catch(err => console.log('SW registration failed:', err));
            });
        }
    </script>
</body>
</html>
